<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OPacmaNET</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:#000;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    min-height:100vh;
    font-family:'Press Start 2P',monospace;
    color:#fff; overflow:hidden;
  }
  h1 {
    color:#FFE000; font-size:1.8rem; letter-spacing:6px;
    text-shadow:0 0 20px #FFE000,0 0 40px #FFE000;
    margin-bottom:8px;
    animation:pulse 2s ease-in-out infinite;
  }
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
  #info{ display:flex; gap:40px; margin-bottom:10px; font-size:0.6rem; }
  #info span{ color:#FFE000; }
  canvas{
    border:3px solid #1a1aff;
    box-shadow:0 0 25px #1a1aff,0 0 50px rgba(26,26,255,0.3);
    display:block; image-rendering:pixelated;
  }
  #message{
    margin-top:12px; font-size:0.65rem; color:#FFE000; height:20px;
    text-shadow:0 0 10px #FFE000;
    animation:blink 1s step-end infinite;
  }
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
  #controls{ margin-top:10px; font-size:0.45rem; color:#666; text-align:center; line-height:2; }
</style>
</head>
<body>
<h1>OPacmaNET</h1>
<div id="info">
  <div>SCORE: <span id="score">0</span></div>
  <div>LIVES: <span id="lives">3</span></div>
  <div>LEVEL: <span id="level">1</span></div>
</div>
<canvas id="c"></canvas>
<div id="message">PRESS ENTER TO START</div>
<div id="controls">ARROW KEYS / WASD TO MOVE &nbsp;|&nbsp; â‚¿ = POWER UP &nbsp;|&nbsp; ðŸ’Š = GHOSTS &nbsp;|&nbsp; OPNET LOGO = YOU</div>
<script>
// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TILE=20, COLS=28, ROWS=31;
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});
canvas.width=TILE*COLS; canvas.height=TILE*ROWS;
ctx.imageSmoothingEnabled=false;

// â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BASE_MAP=[
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1],
  [1,3,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,3,1],
  [1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1],
  [1,2,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1],
  [1,2,2,2,2,2,2,1,1,2,2,2,2,1,1,2,2,2,2,1,1,2,2,2,2,2,2,1],
  [1,1,1,1,1,1,2,1,1,1,1,1,4,1,1,4,1,1,1,1,1,2,1,1,1,1,1,1],
  [1,1,1,1,1,1,2,1,1,1,1,1,4,1,1,4,1,1,1,1,1,2,1,1,1,1,1,1],
  [1,1,1,1,1,1,2,1,1,4,4,4,4,4,4,4,4,4,4,1,1,2,1,1,1,1,1,1],
  [1,1,1,1,1,1,2,1,1,4,1,1,1,4,4,1,1,1,4,1,1,2,1,1,1,1,1,1],
  [1,1,1,1,1,1,2,1,1,4,1,4,4,4,4,4,4,1,4,1,1,2,1,1,1,1,1,1],
  [4,4,4,4,4,4,2,4,4,4,1,4,4,4,4,4,4,1,4,4,4,2,4,4,4,4,4,4],
  [1,1,1,1,1,1,2,1,1,4,1,4,4,4,4,4,4,1,4,1,1,2,1,1,1,1,1,1],
  [1,1,1,1,1,1,2,1,1,4,1,1,1,1,1,1,1,1,4,1,1,2,1,1,1,1,1,1],
  [1,1,1,1,1,1,2,1,1,4,4,4,4,4,4,4,4,4,4,1,1,2,1,1,1,1,1,1],
  [1,1,1,1,1,1,2,1,1,4,1,1,1,1,1,1,1,1,4,1,1,2,1,1,1,1,1,1],
  [1,1,1,1,1,1,2,1,1,4,1,1,1,1,1,1,1,1,4,1,1,2,1,1,1,1,1,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1],
  [1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1],
  [1,3,2,2,1,1,2,2,2,2,2,2,2,4,4,2,2,2,2,2,2,2,1,1,2,2,3,1],
  [1,1,1,2,1,1,2,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,1,1],
  [1,1,1,2,1,1,2,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,1,1],
  [1,2,2,2,2,2,2,1,1,2,2,2,2,1,1,2,2,2,2,1,1,2,2,2,2,2,2,1],
  [1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1],
  [1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];

// â”€â”€ Offscreen helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkCanvas(w,h){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }

// Wall layer â€” built once, never redrawn
const wallCache=mkCanvas(canvas.width,canvas.height);
(function buildWalls(){
  const c=wallCache.getContext('2d',{alpha:false});
  c.fillStyle='#000'; c.fillRect(0,0,wallCache.width,wallCache.height);
  for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) {
    if(BASE_MAP[y][x]===1){
      c.fillStyle='#1a1aff'; c.fillRect(x*TILE,y*TILE,TILE,TILE);
      c.strokeStyle='#3333cc'; c.lineWidth=1;
      c.strokeRect(x*TILE+1,y*TILE+1,TILE-2,TILE-2);
    }
  }
})();

// Dots layer â€” rebuilt when level resets, single dots erased on eat
const dotsCache=mkCanvas(canvas.width,canvas.height);
const dotsCtx=dotsCache.getContext('2d');
function rebuildDots(){
  dotsCtx.clearRect(0,0,dotsCache.width,dotsCache.height);
  for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) {
    if(map[y][x]===2){
      dotsCtx.fillStyle='#FFD700';
      dotsCtx.beginPath();
      dotsCtx.arc(x*TILE+TILE/2,y*TILE+TILE/2,2.5,0,Math.PI*2);
      dotsCtx.fill();
    }
  }
}
function eraseDot(x,y){
  dotsCtx.clearRect(x*TILE+TILE/2-4,y*TILE+TILE/2-4,8,8);
}

// Bitcoin sprite â€” rendered once
const BTC=14;
const btcSprite=mkCanvas(BTC*2,BTC*2);
(function(){
  const c=btcSprite.getContext('2d');
  const cx=BTC,cy=BTC,r=BTC-1;
  const g=c.createRadialGradient(cx-3,cy-3,1,cx,cy,r);
  g.addColorStop(0,'#FFD580'); g.addColorStop(0.5,'#F7931A'); g.addColorStop(1,'#C35A00');
  c.beginPath(); c.arc(cx,cy,r,0,Math.PI*2);
  c.fillStyle=g; c.fill();
  c.strokeStyle='#8B4000'; c.lineWidth=1.5; c.stroke();
  c.fillStyle='#fff';
  c.font=`bold ${Math.floor(r*1.1)}px serif`;
  c.textAlign='center'; c.textBaseline='middle';
  c.fillText('â‚¿',cx+1,cy+1);
})();

// Pill sprites â€” rendered once each
const PW=28,PH=16;
function mkPill(c1,c2,ol,alpha){
  const s=mkCanvas(PW,PH); const c=s.getContext('2d');
  if(alpha!==undefined) c.globalAlpha=alpha;
  const cx=PW/2,cy=PH/2,rx=PW/2-1,ry=PH/2-1;
  c.beginPath(); c.ellipse(cx-rx/2,cy,rx/2,ry,0,Math.PI/2,Math.PI*1.5); c.closePath(); c.fillStyle=c1; c.fill();
  c.beginPath(); c.ellipse(cx+rx/2,cy,rx/2,ry,0,-Math.PI/2,Math.PI/2); c.closePath(); c.fillStyle=c2; c.fill();
  c.strokeStyle=ol; c.lineWidth=1;
  c.beginPath(); c.moveTo(cx,cy-ry); c.lineTo(cx,cy+ry); c.stroke();
  c.beginPath(); c.ellipse(cx,cy,rx,ry,0,0,Math.PI*2); c.strokeStyle=ol; c.lineWidth=1.5; c.stroke();
  c.beginPath(); c.ellipse(cx-4,cy-3,rx*0.3,ry*0.3,-0.3,0,Math.PI*2); c.fillStyle='rgba(255,255,255,0.25)'; c.fill();
  return s;
}
const spPill   = mkPill('#FF6600','#FF9933','#AA3300');
const spScared = mkPill('#0033cc','#0055ee','#001188');
const spFlash  = mkPill('#ffffff','#dddddd','#888888');
const spEaten  = mkPill('#111133','#111144','#000022', 0.35);

// OPNET logo
const opnetImg=new Image();
let opnetLoaded=false;
opnetImg.onload=()=>{ opnetLoaded=true; buildOpnetSprite(); };
opnetImg.src='data:image/jpeg;base64,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';

const opnetSprite=mkCanvas(TILE,TILE);
function buildOpnetSprite(){
  const c=opnetSprite.getContext('2d');
  c.clearRect(0,0,TILE,TILE);
  c.save();
  c.beginPath(); c.arc(TILE/2,TILE/2,TILE/2-1,0,Math.PI*2); c.clip();
  c.drawImage(opnetImg,0,0,TILE,TILE);
  c.restore();
  c.beginPath(); c.arc(TILE/2,TILE/2,TILE/2-1,0,Math.PI*2);
  c.strokeStyle='#FF6600'; c.lineWidth=1.5; c.stroke();
}

// â”€â”€ Game state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let map,pacman,ghosts,score,lives,level,state,frightTimer,frightDuration;
let animFrame=0,tick=0;
const GHOST_COLORS=['#FF0000','#FFB8FF','#00FFFF','#FFB852'];
const GHOST_NAMES=['Blinky','Pinky','Inky','Clyde'];

const PACMAN_SPEED_MS=150, GHOST_SPEED_MS=180, SCARED_SPEED_MS=270, EATEN_SPEED_MS=80;
let lastPacTime=0;
const ghostTimers=[0,0,0,0];
let modeTimer=0,modeIndex=0;
const MODE_DURATIONS=[420,300,420,300,300,200,300];

function deepCopy(a){ return a.map(r=>[...r]); }

function init(){
  map=deepCopy(BASE_MAP);
  score=0; lives=3; level=1;
  frightTimer=0; frightDuration=60;
  modeTimer=0; modeIndex=0;
  state='waiting';
  spawnAll();
  rebuildDots();
  updateUI();
  document.getElementById('message').textContent='PRESS ENTER TO START';
}

function spawnAll(){
  pacman={x:14,y:23,dx:0,dy:0,nextDx:0,nextDy:0};
  ghosts=GHOST_NAMES.map((name,i)=>({
    x:12+(i%4), y:13+Math.floor(i/4),
    dx:0, dy:-1,
    color:GHOST_COLORS[i], name,
    scared:false, eaten:false,
    mode:i===0?'chase':'scatter',
    leaveTimer:i*60, inHouse:true,
  }));
}

function updateUI(){
  document.getElementById('score').textContent=score;
  document.getElementById('lives').textContent=lives;
  document.getElementById('level').textContent=level;
}

function canMove(x,y){
  let tx=x|0, ty=y|0;
  if(tx<0) tx=COLS-1;
  if(tx>=COLS) tx=0;
  return map[ty]!==undefined && map[ty][tx]!==1;
}

// â”€â”€ Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function movePacman(){
  if(canMove(pacman.x+pacman.nextDx, pacman.y+pacman.nextDy)){
    pacman.dx=pacman.nextDx; pacman.dy=pacman.nextDy;
  }
  const mx=pacman.x+pacman.dx, my=pacman.y+pacman.dy;
  if(canMove(mx,my)){
    pacman.x=mx; pacman.y=my;
    if(pacman.x<0) pacman.x=COLS-1;
    if(pacman.x>=COLS) pacman.x=0;
  }
  const gx=pacman.x, gy=pacman.y;
  if(map[gy]&&map[gy][gx]===2){
    map[gy][gx]=4; eraseDot(gx,gy); score+=10; updateUI();
  } else if(map[gy]&&map[gy][gx]===3){
    map[gy][gx]=4; score+=50;
    frightTimer=frightDuration*6;
    ghosts.forEach(g=>{if(!g.eaten)g.scared=true;});
    updateUI();
  }
  if(!map.some(r=>r.includes(2)||r.includes(3))){
    level++; frightDuration=Math.max(40,frightDuration-5);
    map=deepCopy(BASE_MAP); rebuildDots(); spawnAll(); updateUI();
  }
}

function getTarget(g){
  if(g.mode==='scatter') return ({Blinky:[COLS-1,0],Pinky:[0,0],Inky:[COLS-1,ROWS-1],Clyde:[0,ROWS-1]})[g.name];
  if(g.name==='Blinky') return [pacman.x,pacman.y];
  if(g.name==='Pinky')  return [pacman.x+pacman.dx*4,pacman.y+pacman.dy*4];
  if(g.name==='Inky')   return [pacman.x+pacman.dx*2,pacman.y+pacman.dy*2];
  return [pacman.x,pacman.y];
}

function moveGhost(g){
  if(g.inHouse){ if(--g.leaveTimer<=0){g.x=14;g.y=11;g.inHouse=false;g.dx=-1;g.dy=0;} return; }
  const dirs=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}];
  const opp={dx:-g.dx,dy:-g.dy};
  const opts=dirs.filter(d=>!(d.dx===opp.dx&&d.dy===opp.dy)&&canMove(g.x+d.dx,g.y+d.dy));
  if(opts.length===0){g.dx=-g.dx;g.dy=-g.dy;}
  else if(g.scared){const p=opts[Math.floor(Math.random()*opts.length)];g.dx=p.dx;g.dy=p.dy;}
  else{
    const[tx,ty]=getTarget(g); let best=null,bd=Infinity;
    for(const d of opts){const dist=Math.hypot(g.x+d.dx-tx,g.y+d.dy-ty);if(dist<bd){bd=dist;best=d;}}
    if(best){g.dx=best.dx;g.dy=best.dy;}
  }
  const nx=g.x+g.dx,ny=g.y+g.dy;
  if(canMove(nx,ny)){g.x=nx;g.y=ny;if(g.x<0)g.x=COLS-1;if(g.x>=COLS)g.x=0;}
}

function checkCollisions(){
  for(const g of ghosts){
    if(g.inHouse) continue;
    if(Math.abs(g.x-pacman.x)<1&&Math.abs(g.y-pacman.y)<1){
      if(g.scared){
        g.scared=false;g.eaten=true;g.x=14;g.y=13;g.inHouse=true;g.leaveTimer=60;score+=200;updateUI();
      } else if(!g.eaten){
        lives--;updateUI();
        if(lives<=0){state='gameover';document.getElementById('message').textContent='GAME OVER! ENTER TO RESTART';}
        else{state='dying';setTimeout(()=>{spawnAll();state='waiting';document.getElementById('message').textContent='PRESS ENTER TO CONTINUE';},1500);}
        return;
      }
    }
  }
}

function gameTick(now){
  if(state!=='playing') return;
  if(now-lastPacTime>=PACMAN_SPEED_MS){movePacman();lastPacTime=now;}
  ghosts.forEach((g,i)=>{
    const spd=g.eaten?EATEN_SPEED_MS:g.scared?SCARED_SPEED_MS:GHOST_SPEED_MS;
    if(now-ghostTimers[i]>=spd){moveGhost(g);ghostTimers[i]=now;}
  });
  checkCollisions();
  if(frightTimer>0&&--frightTimer===0) ghosts.forEach(g=>g.scared=false);
  if(modeIndex<MODE_DURATIONS.length&&++modeTimer>=MODE_DURATIONS[modeIndex]){
    modeTimer=0;modeIndex++;
    const nm=modeIndex%2===0?'scatter':'chase';
    ghosts.forEach(g=>{if(!g.scared&&!g.inHouse)g.mode=nm;});
  }
}

// â”€â”€ Rendering â€” fully cached, zero per-frame allocations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMap(){
  // 1. Walls (static cache)
  ctx.drawImage(wallCache,0,0);
  // 2. Dots (incrementally updated offscreen canvas)
  ctx.drawImage(dotsCache,0,0);
  // 3. Bitcoin pellets (only 4, scale-pulsed)
  const scale=1+Math.sin(animFrame*0.08)*0.14;
  const s=BTC*scale;
  for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++){
    if(map[y][x]===3){
      ctx.drawImage(btcSprite, x*TILE+TILE/2-s, y*TILE+TILE/2-s, s*2, s*2);
    }
  }
}

function drawPlayer(){
  if(state==='dying') return;
  const bob=Math.sin(animFrame*0.15)*1.5;
  if(opnetLoaded){
    ctx.drawImage(opnetSprite, pacman.x*TILE, pacman.y*TILE+bob);
  } else {
    ctx.fillStyle='#FF6600';
    ctx.beginPath();
    ctx.arc(pacman.x*TILE+TILE/2, pacman.y*TILE+TILE/2+bob, TILE/2-1, 0, Math.PI*2);
    ctx.fill();
  }
}

function drawGhosts(){
  for(const g of ghosts){
    const cx=g.x*TILE+TILE/2, cy=g.y*TILE+TILE/2;
    const tilt=Math.atan2(g.dy,g.dx)+Math.PI/2;
    let sp;
    if(g.eaten) sp=spEaten;
    else if(g.scared) sp=(frightTimer<100&&(animFrame>>3)&1)?spFlash:spScared;
    else sp=spPill;
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(tilt);
    ctx.drawImage(sp,-PW/2,-PH/2,PW,PH);
    ctx.restore();
  }
}

function gameLoop(now){
  gameTick(now);
  animFrame++;
  // Clear only â€” walls drawn via cache
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawPlayer();
  drawGhosts();
  requestAnimationFrame(gameLoop);
}

// â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(){
  state='playing';
  const now=performance.now();
  lastPacTime=now; ghostTimers.fill(now);
  document.getElementById('message').textContent='';
}

document.addEventListener('keydown',e=>{
  const km={ArrowLeft:[-1,0],ArrowRight:[1,0],ArrowUp:[0,-1],ArrowDown:[0,1],
    a:[-1,0],d:[1,0],w:[0,-1],s:[0,1],A:[-1,0],D:[1,0],W:[0,-1],S:[0,1]};
  if(km[e.key]){e.preventDefault();[pacman.nextDx,pacman.nextDy]=km[e.key];}
  if(e.key==='Enter'){
    if(state==='waiting') startGame();
    else if(state==='gameover'){init();startGame();}
  }
});

let touchStart=null;
canvas.addEventListener('touchstart',e=>{touchStart=e.touches[0];e.preventDefault();},{passive:false});
canvas.addEventListener('touchend',e=>{
  if(!touchStart) return;
  const dx=e.changedTouches[0].clientX-touchStart.clientX;
  const dy=e.changedTouches[0].clientY-touchStart.clientY;
  if(Math.abs(dx)>Math.abs(dy)){pacman.nextDx=dx>0?1:-1;pacman.nextDy=0;}
  else{pacman.nextDy=dy>0?1:-1;pacman.nextDx=0;}
  if(state==='waiting') startGame();
  touchStart=null;
},{passive:false});

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
